<template>
  <div>
    <code>{{ $route.params.key }}</code>
    <div>
      <label v-if="editingMetadata">
        Picture URL:
        <input v-model="editingMetadata.picture" />
      </label>
      <img
        v-else-if="(metadata.picture || '').length"
        :src="metadata.picture"
      />
    </div>
    <div>
      <form v-if="editingName !== null" @submit="savePetName">
        <label>
          Petname:
          <input v-model="editingName" />
          (Will be made public)
        </label>
        <button>Save</button>
      </form>
      <div v-else-if="editingMetadata">
        <label v-if="editingMetadata">
          Name:
          <input v-model="editingMetadata.name" />
        </label>
      </div>
      <div v-else>
        <h1>{{ $store.getters.keyName(this.$route.params.key) }}</h1>
        <button
          v-if="!myself"
          @click="editingName = $store.getters.keyName(this.$route.params.key)"
        >
          Rename
        </button>
      </div>
    </div>
    <h2 v-if="$store.getters.keyName(this.$route.params.key) !== metadata.name">
      {{ metadata.name }}
    </h2>
    <div v-if="!myself">
      <button v-if="following" @click="unfollow">Unfollow</button>
      <button v-else @click="follow">Follow</button>
    </div>
    <article>
      <span v-if="!editingMetadata">{{ metadata.about }}</span>
      <label v-else>
        About: <textarea v-model="editingMetadata.about"></textarea>
      </label>
    </article>
    <div>
      <button
        v-if="myself && !editingMetadata"
        @click="editingMetadata = {...metadata}"
      >
        Edit
      </button>
      <button v-else-if="editingMetadata" @click="saveEditedMetadata">
        Save
      </button>
    </div>
    <List :notes="notes" />
  </div>
</template>

<script>
  export default {
    data() {
      return {
        editingMetadata: null,
        editingName: null
      }
    },
    computed: {
      myself() {
        return this.$route.params.key === this.$store.getters.pubKeyHex
      },
      metadata() {
        return this.$store.state.metadata.get(this.$route.params.key) || {}
      },
      following() {
        return (
          this.$store.state.following.indexOf(this.$route.params.key) !== -1
        )
      },
      notes() {
        var notes = []
        for (let k of this.$store.state.browsing.keys()) {
          if (k === 'from:' + this.$route.params.key) {
            let note = this.$store.state.browsing.get(k)
            notes.push(note)
          }
        }
        notes.sort((a, b) => b.created_at - a.created_at)
        return notes
      }
    },
    methods: {
      follow(e) {
        e.preventDefault()
        this.$store.commit('follow', this.$route.params.key)
      },
      unfollow(e) {
        e.preventDefault()
        this.$store.commit('unfollow', this.$route.params.key)
      },
      saveEditedMetadata(e) {
        e.preventDefault()
        this.$store.dispatch('publishMetadata', this.editingMetadata)
        this.editingMetadata = null
      },
      savePetName(e) {
        e.preventDefault()
        this.$store.commit('savePetName', {
          pubkey: this.$route.params.key,
          name: this.editingName
        })
        this.editingName = null
      }
    },
    mounted() {
      this.$store.dispatch('browseProfile', this.$route.params.key)
    }
  }
</script>

<style module>
  a {
    cursor: pointer;
    color: blue;
    text-decoration: underline;
  }
</style>
